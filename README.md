<h1>Malware Analysis Lab</h1>

<h2>Description</h2>
a completely isolated network with machines for malware analysis and detection. It's a key part of the infrastructure of any SOC, CERT or CIRT
<br />


<h2>Languages and Utilities Used</h2>

- <b>PowerShell</b> 
- <b>VirtualBox</b>
- <b>Remnux</b>

<h2>Environments Used </h2>

- <b>Windows 10</b> (21H2)

<h2>Program walk-through:</h2>

VirtualBox:
https://www.virtualbox.org/wiki/Downloads

Windows 10 Enterprise:
- Microsoft Evaluation Center: https://info.microsoft.com/ww-landing-windows-10-enterprise.html
- Direct Download: https://www.microsoft.com/en-us/evalcenter/download-windows-10-enterprise

Remnux:
https://docs.remnux.org/install-distro/get-virtual-appliance

<p align="center">
Setup Windows 10 With Guest Additions <br/>
<img src="https://i.imgur.com/GT3MCYP.png  height="80%" width="80%" alt="Disk Sanitization Steps"/>
<br />
<br />
Create a new Virtual Machine.:  <br/>
<img src=https://imgur.com/E5LeBCj.png" height="80%" width="80%" alt="Disk Sanitization Steps"/>
<br />
<br />
Create a new partition.: <br/>
<img src=https://imgur.com/wKCscuk.png" height="80%" width="80%" alt="Disk Sanitization Steps"/>
<br />
<br />
 Choose Domain Join:  <br/>

<br />
<br />
  <br/>
<img src=https://imgur.com/fRH8xGI.png" height="80%" width="80%" alt="Disk Sanitization Steps"/>
<br />
<br />
Devices -> Insert Guest Additions CD Image:  <br/>

<br />
<br />
Setup FlareVM

1. **Download and Install Browsers:**
   - Chrome: https://www.google.com/chrome/
   - Firefox: https://www.mozilla.org/en-US/firefox/new/

2. **Optional: Download Windows Terminal:**
   - Open PowerShell as an administrator and run the following commands:

     ```powershell
     wget https://aka.ms/Microsoft.VCLibs.x64.14.00.Desktop.appx -usebasicparsing -o VCLibs.appx
     wget https://github.com/microsoft/terminal/releases/download/v1.15.3465.0/Microsoft.WindowsTerminal_Win10_1.15.3465.0_8wekyb3d8bbwe.msixbundle -UseBasicParsing -o winterminal.msixbundle
     ```

   - Add the VCLibs package:

     ```powershell
     Add-AppxPackage [C:\path\to\downloaded\VCLibs.appx]
     ```

   - Install the Windows Terminal MSIX bundle:

     ```powershell
     Add-AppxPackage [C:\path\to\downloaded\winterminal.msixbundle]
     ```

   - (Optional) Pin Windows Terminal to the taskbar.

3. **Disable Proxy Auto-Detect:**
   - In the Windows search bar, search for "proxy settings".
   - Switch the "Automatically detect settings" button off.

4. **Disable Windows Defender:**
   - **Disable Tamper Protection:**
     - Search "Defender", open Defender settings, and set all Defender settings to off.
   - **Disable Windows Defender via Group Policy:**
     - In the Windows Search Bar, search and select "edit group policy".
     - Navigate to: Administrative Templates → Windows Components → Microsoft Defender Antivirus
     - Enable "Turn off Microsoft Defender Antivirus".
   - **Disable Windows Firewall via Group Policy:**
     - Navigate to: Administrative Templates → Network → Network Connections → Windows Defender Firewall
     - For both Domain Profile and Standard Profile, disable "Protect All Network Connections".

5. **Take a Snapshot:**
   - Take a snapshot of your VM in its current state.

6. **Download and Install FlareVM:**
   - In a PowerShell Admin prompt, run:

     ```powershell
     (New-Object net.webclient).DownloadFile('https://raw.githubusercontent.com/mandiant/flarevm/main/install.ps1',"$([Environment]::GetFolderPath('Desktop'))\install.ps1")
     ```

   - Change directories to the Desktop:

     ```powershell
     cd $([Environment]::GetFolderPath('Desktop'))
     ```

   - Unblock the downloaded script:

     ```powershell
     Unblock-File .\install.ps1
     ```

   - Set the execution policy to unrestricted:

     ```powershell
     Set-ExecutionPolicy Unrestricted
     ```

   - Accept the prompt to set the execution policy to unrestricted if one appears.
   - Run the FlareVM installation script:

     ```powershell
     .\install.ps1
     ```

   - Follow the rest of the prompts and continue with the installation.

7. **Take Another Snapshot:**
   - This is the base FlareVM installation.

8. **VirtualBox Network Settings:**
   - Create an isolated host-only adapter network in VirtualBox to allow the Windows 10 machine and Remnux to communicate with each other.

<p align="center">
 1. Create a new Host-only Network.<br/>
<img src=https://imgur.com/xDDZlAX.png  height="80%" width="80%" alt="Disk Sanitization Steps"/>
<br />
<br />
2. Right Click -> Properties. Set IPv4 Address to a separate private range (ex. 10.0.0.1). Set DHCP
Server address to x.x.x.2, lower bound to x.x.x.3 and upper to x.x.x.254.<br/>
<img src=https://imgur.com/eSiEe0I.png  height="80%" width="80%" alt="Disk Sanitization Steps"/>
<br />
<br />
<img src=https://imgur.com/ZMxHv2A.png  height="80%" width="80%" alt="Disk Sanitization Steps"/>
<br />
<br />
3. Ensure all VMs are using Host-only Adapter, Isolated Ethernet Adapter.<br/>
<img src=https://imgur.com/I8wPky7.png  height="80%" width="80%" alt="Disk Sanitization Steps"/>
<br />
<br />
Creating a Fake Network in Remnux

1. **Start INetSim Service:**
   - Open a terminal in Remnux.
   - Run the following command to start the INetSim network service:

     ```bash
     sudo inetsim
     ```

2. **Edit INetSim Configuration File:**
   - Open the INetSim configuration file for editing:

     ```bash
     sudo nano /etc/inetsim/inetsim.conf
     ```

   - **Uncomment the `start_service dns` line:**
     Find the line that says `#start_service dns` and remove the `#` to uncomment it:

     ```plaintext
     start_service dns
     ```

   - **Set the `service_bind_address` to `0.0.0.0`:**
     Find the line with `service_bind_address` and set it to `0.0.0.0`:

     ```plaintext
     service_bind_address = 0.0.0.0
     ```

   - **Set the DNS Default IP to the IP address of the Remnux VM:**
     Replace the DNS default IP with the IP address of the Remnux VM (e.g., `10.0.0.4`):

     ```plaintext
     dns_default_ip = 10.0.0.4
     ```

   - Save the changes and exit the editor (Ctrl+X, then Y, then Enter in nano).

3. **Serving Valid HTTP Responses:**
   - **In the Windows Box:**
     - **Standard 200 Response:**
       Enter the IP address of Remnux in a browser to receive a standard 200 response.

       ```plaintext
       http://10.0.0.4/malware.exe
       ```
       This URL always serves a test binary when typing in the `.exe` extension.

     - **Valid DNS Response:**
       For any URL, `my_malware.info` will serve a valid DNS response.

       ```plaintext
       http://my_malware.info
       ```

4. **Configuring Windows Firewall Inbound Rule:**
   - If Remnux cannot ping the FlareVM host, add an inbound rule in Windows Firewall to allow all traffic from the Remnux IP address:
     - Open **Windows Defender Firewall** from the Control Panel.
     - Go to **Advanced Settings**.
     - Select **Inbound Rules** and then click **New Rule**.
     - Choose **Custom** and click **Next**.
     - Select **This program path** and browse to `C:\Windows\System32\svchost.exe`.
     - Click **Next** and select **Allow the connection**.
     - Click **Next** and ensure all profiles (Domain, Private, Public) are checked.
     - Enter a name for the rule, such as "Allow Traffic from Remnux", and click **Finish**.
     <br />
     <br />
     <img src=https://imgur.com/nWOZuZs.png  height="80%" width="80%" alt="Disk Sanitization Steps"/>
     <br />
     <br />
     Open Windows Defender Firewall.<br/>
     <img src=https://imgur.com/d0BbvaV.png  height="80%" width="80%" alt="Disk Sanitization Steps"/>
       <br />
       <br />
     Click "Inbound Rules" -> "New Rule..."
    <br />
    Choose Custom -> Next, All Programs -> Next, Leave default Protocol and Ports -> Next
    <br />
    <br />
    <img src=https://imgur.com/fbUBOG3.png  height="80%" width="80%" alt="Disk Sanitization Steps"/>
    <br />
    Under the remote IP addresses, choose "Add", enter the Remnux IP address (10.0.0.4).
    <br/ >
    Choose "Allow the connection", leave default for Profile, Name the rule -> Finish.
    


     


